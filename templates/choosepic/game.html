{% load staticfiles %}
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html" charset="utf-8">
        <title>Choose Picture</title>
    </head>
    <body onload="resetBoard();">
        <style>
            @font-face { 
                font-family: 'BhashitaComplex';
                src: '{% static '/choosepic/fonts/LBhashitaComplex.ttf' %}';
            } 

            .container {
                width: 640px;
                height: 480px;
                margin: auto;
            }

            .row {
                width: 100%;
                height: 33.33333333333%
            }

            .cell {
                width: 25%;
                height: 100%;
                text-align: center;
            }

            .cell img {
                max-width: 100%;
                -webkit-border-radius: 10px;
                -moz-border-radius: 10px;
                border-radius: 10px;
            }

            .ctrlpanel {
                width: 50%;
                height: 100%;
                text-align: center;
                position: relative;
            }

            .panelchild {
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                background-color: white;
                font-family: BhashitaComplex;
                font-size: 30px;
            }

            .left {
                float: left;
            }

            .right {
                float: right;
            }

            .score {
                width: 80%;
                margin: auto;
                text-align: center;
            }
        </style>

<script type="text/javascript" charset="utf-8">
// These are generated by django and hence are synchronised
var words=new Array ({% for word in words%}'{{word}}', {% endfor %}null);
var images = new Array({% for url in urls%}'{{url|escapejs}}', {% endfor %}null);
nbImages={{words | length}};

var maxRounds = 20;

// The control panel has the following states
var ctrlPanelStates = {
    READY : 1,
    PEEKING : 2,
    BLANK : 3,
    DONE : 4,
};

function setCtrlPanelState(s)
{
    switch(s) {
        case ctrlPanelStates.READY:
            document.getElementById("gameover").style.zIndex = "0";
            document.getElementById("wordpanel").style.zIndex = "1";
            document.getElementById("glasspanel").style.zIndex = "4";
            document.getElementById("blankpanel").style.zIndex = "3";
            break;

        case ctrlPanelStates.PEEKING:
            document.getElementById("gameover").style.zIndex = "0";
            document.getElementById("wordpanel").style.zIndex = "4";
            document.getElementById("glasspanel").style.zIndex = "2";
            document.getElementById("blankpanel").style.zIndex = "1";
            break;

        case ctrlPanelStates.BLANK:
            document.getElementById("gameover").style.zIndex = "0";
            document.getElementById("wordpanel").style.zIndex = "1";
            document.getElementById("glasspanel").style.zIndex = "2";
            document.getElementById("blankpanel").style.zIndex = "3";
            break;

        case ctrlPanelStates.DONE:
            document.getElementById("wordpanel").style.zIndex = "1";
            document.getElementById("glasspanel").style.zIndex = "2";
            document.getElementById("blankpanel").style.zIndex = "3";
            document.getElementById("gameover").style.zIndex = "4";
            break;
    }
}

function resetScore()
{
    for (i = 0; i < maxRounds; i++) {
        document.images["oui" + i].src = '{% static "choosepic/img/unscored.png" %}';
    }
}

function showAllImages()
{
    for (i=0; i<nbImages; i++) {
        document.images["case"+ i].src=images[i];
    }
}

function clearAllImages()
{
    for (i=0; i<nbImages; i++) {
        document.images["case"+ i].src = '{% static "choosepic/img/blank.png" %}';
    }
}

// The game has a state machine and these are the events
var gameEvents = {
STATE_ENTRY : -2,
              STATE_EXIT : -1,
              RESET : 0,
              PEEK : 1,
              CLOSEPEEK : 2,
              CHOOSE : 3,
};

// State machine specific variables
var gameState = initState;
var nextState = null;

// The answer for each round of the game
var answer = 0;
var gameRound = 0;

function setState(stateFunction)
{
    nextState = stateFunction;
}

// Game state functions.
// Initialise state. Immediately goes to idle
function initState(event, payload)
{
    if (event == gameEvents.RESET) {
        setState(startGameState);
    }
}

// The player is able to peek at the word
function readyToPeekState(event, payload)
{
    switch(event) {
        case gameEvents.STATE_ENTRY:
            setCtrlPanelState(ctrlPanelStates.READY);
            break;

        case gameEvents.PEEK:
            setState(awaitChoiceState);
            break;

        default:
            break;
    }
}

// State reached in the beginning of the game (first round). This is a child state
// of readToPeekState
function startGameState(event, payload)
{
    switch(event) {
        case gameEvents.STATE_ENTRY:
            // first enter the parent state
            readyToPeekState(event, payload);
            showAllImages();
            resetScore();
            gameRound = 0;
            break;

        default:
            readyToPeekState(event, payload)
                break;
    }
}

// State reached in the beginning of subsequent rounds. This is a child state
// of readToPeekState
function startRoundState(event, payload)
{
    switch(event) {
        case gameEvents.STATE_ENTRY:
            readyToPeekState(event, payload);
            break;

        default:
            readyToPeekState(event, payload)
                break;
    }
}

// The player has requested peeking the word. This state handles
// displaying the word briefly as well as the users choice.
function awaitChoiceState(event, payload)
{
    switch(event) {
        case gameEvents.STATE_ENTRY:
            showAllImages();
			do {
				prev=answer;
    	        answer=Math.floor(Math.random()*nbImages);
			} while(prev == answer);
            document.getElementById("word").innerHTML = words[answer];
            setCtrlPanelState(ctrlPanelStates.PEEKING);
            t1=setTimeout("onPeekOver()", 2000)
                break;

        case gameEvents.STATE_EXIT:
            clearTimeout(t1);
            break;

        case gameEvents.CLOSEPEEK:
            setCtrlPanelState(ctrlPanelStates.BLANK);
            break;

        case gameEvents.CHOOSE:
            // The payload is the choice
            document.images["oui"+gameRound].src = (payload == answer) ? '{% static "choosepic/img/happy.png" %}' : '{% static "choosepic/img/sad.png" %}';
            for (i=0; i<nbImages; i++) {
                document.images["case" + i].src = (i == answer) ? images[i] : '{% static "choosepic/img/blank.png" %}';
            }
            gameRound++;
            (gameRound == maxRounds) ? setState(gameOverState) : setState(startRoundState);
            break;

        default:
            break;
    }
}

// The game is over. Player can either restart the game or return
// to the previous screen.
function gameOverState(event, payload)
{
    switch(event) {
        case gameEvents.STATE_ENTRY:
            setCtrlPanelState(ctrlPanelStates.DONE);
            clearAllImages();
            break;

        case gameEvents.RESET:
            setState(startGameState);
            break;

        default:
            break;
    }
}

function stateMachine(event, payload)
{
    gameState(event, payload);
    if (gameState != nextState) {
        gameState(gameEvents.STATE_EXIT, null);
        nextState(gameEvents.STATE_ENTRY, null);
        gameState = nextState;
    }
}

// Functions that generate events. These are called by various
// events from the HTML doc objects
function resetBoard()
{
    stateMachine(gameEvents.RESET, null);
}

function onPeekRequest()
{
    stateMachine(gameEvents.PEEK, null);
}

function onPeekOver()
{
    stateMachine(gameEvents.CLOSEPEEK, null);
}

function onChoose(choice)
{
    stateMachine(gameEvents.CHOOSE, choice);
}
</script>

<div class="container">
    <div class="row">
        <div class="cell left"><a href="#" onmousedown="onChoose(0);"><img src='{% static "choosepic/img/blank.png" %}' name="case0"></a></div>
        <div class="cell left"><a href="#" onmousedown="onChoose(1);"><img src='{% static "choosepic/img/blank.png" %}' name="case1"></a></div>
        <div class="cell left"><a href="#" onmousedown="onChoose(2);"><img src='{% static "choosepic/img/blank.png" %}' name="case2"></a></div>
        <div class="cell left"><a href="#" onmousedown="onChoose(3);"><img src='{% static "choosepic/img/blank.png" %}' name="case3"></a></div>
    </div>
    <div class="row">
        <div class="cell left"><a href="#" onmousedown="onChoose(4);"><img src='{% static "choosepic/img/blank.png" %}' name="case4"></a></div>
        <div class="ctrlpanel left">
            <div class="panelchild" id="gameover">
                <a href="#" onmousedown="resetBoard();"> <img src='{% static "choosepic/img/play.png" %}'/></a>
                <a href="www.google.com"> <img src='{% static "choosepic/img/stop.png" %}'/></a>
            </div>
            <div class="panelchild" id="wordpanel">
                <p id="word"></p>
            </div>
            <div class="panelchild" id="glasspanel">
                <a href="#" onmousedown="onPeekRequest();"><img src='{% static "choosepic/img/glass.png" %}'/></a>
            </div>
            <div class="panelchild" id="blankpanel"></div>
        </div>
        <div class="cell left"><a href="#" onmousedown="onChoose(5);"><img src="{% static "choosepic/img/blank.png" %}" name="case5"></a></div>
    </div>
    <div class="row">
        <div class="cell left"><a href="#" onmousedown="onChoose(6);"><img src='{% static "choosepic/img/blank.png" %}' name="case6"></a></div>
        <div class="cell left"><a href="#" onmousedown="onChoose(7);"><img src='{% static "choosepic/img/blank.png" %}' name="case7"></a></div>
        <div class="cell left"><a href="#" onmousedown="onChoose(8);"><img src='{% static "choosepic/img/blank.png" %}' name="case8"></a></div>
        <div class="cell left"><a href="#" onmousedown="onChoose(9);"><img src='{% static "choosepic/img/blank.png" %}' name="case9"></a></div>
    </div>
</div>
<div class="score">
    <img src={% static "choosepic/img/unscored.png" %} name="oui0">
    <img src={% static "choosepic/img/unscored.png" %} name="oui1">
    <img src={% static "choosepic/img/unscored.png" %} name="oui2">
    <img src={% static "choosepic/img/unscored.png" %} name="oui3">
    <img src={% static "choosepic/img/unscored.png" %} name="oui4">
    <img src={% static "choosepic/img/unscored.png" %} name="oui5">
    <img src={% static "choosepic/img/unscored.png" %} name="oui6">
    <img src={% static "choosepic/img/unscored.png" %} name="oui7">
    <img src={% static "choosepic/img/unscored.png" %} name="oui8">
    <img src={% static "choosepic/img/unscored.png" %} name="oui9">
    <img src={% static "choosepic/img/unscored.png" %} name="oui10">
    <img src={% static "choosepic/img/unscored.png" %} name="oui11">
    <img src={% static "choosepic/img/unscored.png" %} name="oui12">
    <img src={% static "choosepic/img/unscored.png" %} name="oui13">
    <img src={% static "choosepic/img/unscored.png" %} name="oui14">
    <img src={% static "choosepic/img/unscored.png" %} name="oui15">
    <img src={% static "choosepic/img/unscored.png" %} name="oui16">
    <img src={% static "choosepic/img/unscored.png" %} name="oui17">
    <img src={% static "choosepic/img/unscored.png" %} name="oui18">
    <img src={% static "choosepic/img/unscored.png" %} name="oui19">
</div>
</body>
</html>
